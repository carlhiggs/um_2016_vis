---
title: "Tree coverage percentage map"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: [ "menu" ]
    source_code: embed
    theme: flatly
runtime: shiny

---


```{r setup, include=FALSE}
# Carl Higgs, RMIT 2019
# Flexdashboard implementation is based on code from [Jasmine Dumas](https://jasminedumas.shinyapps.io/hartford-crime/)
# Load packages and initialize data here
library(flexdashboard)
library(leaflet)
library(geojsonio)
library(knitr)
library(shiny)

# selectInput("state", label = "Select an indicator: ",
#            choices = state.abb, selected = "Private")
```
Map
=========================

Sidebar {.sidebar} 
----------------------------
An interactive visualisation of tree coverage for local government areas (LGAs) in Sydney, detailing percent on public, private or other land.  Based on analysis of modified mesh block data derived from Urban Monitor imagery for 2016. Centre for Urban Resarch, RMIT 2019.

Column {data-width=600}
-------------------------------------
    
### Map
```{r}
server <- function(input, output) {
  # build data with 2 places
  um_2016_lga <- geojson_read("um_2016_pp_lga_simplified.geojson",what = "sp")
  # um_2016_ssc <- geojson_read("um_2016_pp_ssc.geojson",what = "sp")
  um_2016_lga@data <- um_2016_lga@data[order(um_2016_lga@data$peranytree_total),]
  um_2016_overall = read.csv("um_2016_pp_overall.csv", header = TRUE)
  left_inches <-  max(strwidth(um_2016_lga@data [,'lga'], "inch")+0.4, na.rm = TRUE)
  bar_data <- as.matrix(t(um_2016_lga@data[, c('peranytree_public','peranytree_private','peranytree_other')]))
  bar_legend_x <- ncol(bar_data) + 3    
  bar_legend_y <- max(colSums(bar_data))
  bar_labels <- um_2016_lga@data[,'lga']
  colours <- c('#7fc97f','#beaed4','#fdc086')
  legend_domain <- range(0,100)
  pal <- colorNumeric(palette = "RdYlGn", domain = legend_domain)

  
  groupNames <- c(paste0("<span style='color: #000000; font-size: 11pt'><strong>Total</strong></span>"),
                  paste0("<span style='color: #000000; font-size: 11pt'><strong>Public</strong></span>"),
                  paste0("<span style='color: #000000; font-size: 11pt'><strong>Private</strong></span>"),
                  paste0("<span style='color: #000000; font-size: 11pt'><strong>Other</strong></span>"))
  
  # create area_popup
  area_popup_lga <- paste0("<strong>LGA: </strong>", 
                      um_2016_lga$lga, 
                      "<br><strong>Tree area percent</strong>", 
                      "<br><i>&nbsp&nbspPublic: </i>", 
                      um_2016_lga$peranytree_public,"%", 
                      "<br><i>&nbsp&nbspPrivate: </i>", 
                      um_2016_lga$peranytree_private,"%", 
                      "<br><i>&nbsp&nbspOther: </i>", 
                      um_2016_lga$peranytree_other,"%", 
                     "<br><i>&nbsp&nbspTotal: </i>", 
                      um_2016_lga$peranytree_total,"%", 
                      "<br><strong>Data coverage area: </strong>",
                      um_2016_lga$fullarea_sqkm," km<sup>2</sup>",
                      "<br><strong>Total area: </strong>",
                      um_2016_lga$area_albers_sqkm," km<sup>2</sup>")
                      
  data_of_hover <- reactiveValues(hoverFeature=NULL)
  
  # Leaflet map with 2 markers
  output$map <- renderLeaflet({
    leaflet() %>% 
    # leaflet(data = um_2016_lga) %>%
    addProviderTiles("CartoDB.Positron") %>%
    addPolygons(data = um_2016_lga,
                layerId = paste0(um_2016_lga@data$lga,'_tot'),
                fillOpacity = 0.7, 
                color = ~pal(peranytree_total), 
                weight = 1, 
                popup = area_popup_lga,
                group=groupNames[1]) %>%
    addPolygons(data = um_2016_lga,
                layerId = paste0(um_2016_lga@data$lga,'_pub'),
                fillOpacity = 0.7,
                color = ~pal(peranytree_public),
                weight = 1,
                popup = area_popup_lga,
                group=groupNames[2]
                # , options = pathOptions(clickable = FALSE)
                ) %>%
    addPolygons(data = um_2016_lga,
                layerId = paste0(um_2016_lga@data$lga,'_pri'),
                fillOpacity = 0.7,
                color = ~pal(peranytree_private),
                weight = 1,
                popup = area_popup_lga,
                group=groupNames[3]
                # , options = pathOptions(clickable = FALSE)
                ) %>%
    addPolygons(data = um_2016_lga,
                layerId = paste0(um_2016_lga@data$lga,'_oth'),
                fillOpacity = 0.7,
                color = ~pal(peranytree_other),
                weight = 1,
                popup = area_popup_lga,
                group=groupNames[4]
                # , options = pathOptions(clickable = FALSE)
                ) %>%
    # define layers and layers tool bar
    addLayersControl(baseGroups = groupNames,
                     options = layersControlOptions(collapsed = TRUE))%>% ## display legend by default
    addScaleBar(position = "bottomleft", options = scaleBarOptions()) %>%
    addLegend("bottomright", 
              pal = pal, 
              values = legend_domain,
              title = "Total % tree coverage",
              opacity = 0.6)
  })
  
  # observe({
    # req(input$var)
    # leafletProxy("map") %>%
      # addPolygons(data = um_2016_lga,
                  # layerId=~lga, 
                  # fillOpacity = 0.7, 
                  # color = ~pal(input$var), 
                  # weight = 1, 
                  # popup = area_popup_lga,
                  # group=groupNames[1]) 
  # })
  
  # # store the click
  # observeEvent(input$map_shape_click,{
    # data_of_click$clickedMarker  <- input$map_shape_click
    # # print(paste0(data_of_click$clickedMarker))
  # })
  # store the hover
  observeEvent(input$map_shape_mouseover,{
    data_of_hover$hoverFeature  <- input$map_shape_mouseover
    data_of_hover$hoverFeature[1] <- substring(toString(data_of_hover$hoverFeature[1]),1,nchar(data_of_hover$hoverFeature[1])-4)
  })
  
  output$pieplot=renderPlot({
    area_of_interest=data_of_hover$hoverFeature[1]
    # print(area_of_interest)
    if(is.null(area_of_interest)){
        area_stats=as.numeric(um_2016_overall[,c('peranytree_public','peranytree_private','peranytree_other')])
        area_labels = c(paste0('public (',area_stats[1],'%)'),
                    paste0('private (',area_stats[2],'%)'),
                    paste0('other (',area_stats[3],'%)'))
        pie(x = area_stats,
        labels=area_labels, 
        col=colours,
        main="Tree coverage %\nSydney",
        border = '#ffffff')
    }else{
        area_stats=as.numeric(um_2016_lga@data[um_2016_lga@data[,'lga']==area_of_interest,c('peranytree_public','peranytree_private','peranytree_other')])
        area_labels = c(paste0('public (',area_stats[1],'%)'),
                    paste0('private (',area_stats[2],'%)'),
                    paste0('other (',area_stats[3],'%)'))
        pie(x = area_stats,
        labels=area_labels, 
        col=colours,
        main=toString(area_of_interest),
        border = '#ffffff')
    }
  })
  
  # Make a barplot or scatterplot depending of the selected point
  output$barplot=renderPlot({
    area_of_interest=data_of_hover$hoverFeature[1]
    if(is.null(area_of_interest)){
        par(mai=c(1.02,left_inches,0.82,0.42))
        barplot(bar_data,
                horiz=TRUE,
                xlim = c(0,100),
                col=c('#7fc97f','#beaed4','#fdc086'), 
                border='#ffffff', 
                names.arg=bar_labels,
                las=1,
                legend.text=c("Public","Private","Other"),
                args.legend=list(bty = "n", 
                                 horiz=TRUE, 
                                 x=50,
                                 xjust=0.5,
                                 yjust=0)
                )
                title(paste0("Tree area percent of ",toupper('lga'),"s, by land status."), line=2, adj=0)
    }else{
        par(mai=c(1.02,left_inches,0.82,0.42))
        barplot(bar_data,
                horiz=TRUE,
                xlim = c(0,100),
                col=c('#7fc97f','#beaed4','#fdc086'), 
                border='#ffffff', 
                names.arg=replace(as.vector(bar_labels),bar_labels!=area_of_interest,''),
                las=1,
                legend.text=c("Public","Private","Other"),
                args.legend=list(bty = "n", 
                                 horiz=TRUE, 
                                 x=25,
                                 xjust=0.5,
                                 yjust=0)
                )
                title(paste0("Tree area percent of ",toupper('lga'),"s, by land status."), line=2, adj=0)
    }
  })


  
}


ui <- fluidPage(
  # selectInput("var", label = "Select a variable", choices = c('peranytree_public','peranytree_private','peranytree_other','peranytree_total')),
  br(),
  column(6,leafletOutput("map")),
  column(4,plotOutput("pieplot", width="300px")),
  column(4,plotOutput("barplot", width="300px")),
  br()
)

shinyApp(ui = ui, server = server)
```


Reproducible Script
===================================== 

```{r, echo=TRUE, eval=FALSE}
 
### Put code here when done 

```


About
===================================== 

Based on code from https://jasminedumas.shinyapps.io/Choropleth_Zipcodes/#map
